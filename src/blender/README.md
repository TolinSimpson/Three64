# Three64 Blender Add-on

The Three64 Blender add-on streamlines two workflows:

- Component authoring: load JSON component descriptors and stamp object custom properties that the runtime reads.
- NavMesh baking: export a lightweight navigation mesh JSON for runtime A* pathfinding.


## Requirements

 - Blender 4.3+
- Three64 repo checked out (this folder is at `src/blender/`)


## Installation

1. Open Blender → Edit → Preferences → Add-ons.
2. Click “Install…”, select `src/blender/three64_blender_addon.py`, then enable “Three64 Component Data”.
3. Optional: In Add-on Preferences, set “Component Data Directory”:
   - Default is `//component-data` (relative to your .blend).
   - Point this to a folder containing JSON component definitions (e.g. the repo’s generated component JSONs).
4. Use the “Reload Three64 Components” button whenever you update the JSON files.


## Component Authoring UI

- Select any object.
- Properties → Object → “Three64 Component” panel.
- Click “Mark Navigable” to add the `navigable = True` custom property on the active object.
- Click “Mark Double-Sided” to add the `doubleSided = True` custom property. At runtime, Three64 forces double-sided rendering for meshes under this object.
- Choose a component from the dropdown and click “Add”.
  - This stamps custom properties on the object (including nested values flattened as dotted keys).
  - Color params get a color picker + hex field.
  - Existing keys are not overwritten when adding an additional component instance.

Tip: The same UI is mirrored inside the default “Custom Properties” panel for convenience.


## Baking a NavMesh (JSON)

You can export a simple triangle-soup navmesh as JSON for use by the Three64 runtime.

1. Tag walkable meshes in the scene by adding a custom property:
   - Select a mesh, click “Mark Navigable” in the “Three64 Component” panel; it sets `navigable = True`.
   - Alternatively, add the `navigable = True` custom property manually.
2. Open 3D Viewport → press “N” → NavMesh tab → “Three64 NavMesh” panel.
3. Configure:
   - Filter Property: name of the custom property to include (default: `navigable`).
   - Max Slope (deg): triangles steeper than this (relative to Blender Z-up) are discarded.
   - Convert to Three.js (Y-up): converts Blender coords (x,y,z) → Three.js (x,z,-y). Keep enabled.
   - Apply Modifiers: exports evaluated meshes with modifiers applied.
   - Export Path: where to write JSON (supports `//` relative to .blend).
     - Recommended path for this repo during dev: `C:/Users/Tolin/Desktop/Three64/public/build/assets/component-data/navmesh.json`
   - Wireframe: display the preview as wireframe when visualizing (viewport-only).
4. Click “Bake & Export NavMesh (JSON)”. The output file contains:
   - `vertices`: array of `[x, y, z]` float triplets
   - `triangles`: flat array of vertex indices (groups of 3)
5. Visualize in Blender:
   - In the same NavMesh panel, click “Visualize NavMesh (JSON)” to create/update a `NavMeshPreview` mesh object from the current Export Path.
   - The preview converts axes back to Blender coordinates if the JSON was exported with “Convert to Three.js (Y-up)”.

Notes:
- Only objects of type “MESH” are considered.
- Slope is measured against Blender’s Z-up; the exporter filters out overly steep faces.


## Using the NavMesh at Runtime

The runtime includes a `NavMesh` component (`src/runtime/navmesh.js`) and integrates with the `Agent` component for pathfinding:

- Ensure the JSON is served from your site. With the suggested export path above, it is accessible at `assets/component-data/navmesh.json` relative to the site base.
- Author the `NavMesh` component in Blender:
  - Select an object (an Empty is fine), pick “NavMesh” in the Three64 Component panel, click “Add”.
  - Set the `url` param to `assets/component-data/navmesh.json` (or your chosen path).
- Configure your Agents to use the navmesh:
  - In the Agent component params, set `useNavMesh: true` (and optionally `repathInterval` in seconds).

At runtime:
- `NavMesh` loads the JSON, builds triangle adjacency, runs A* and applies funnel smoothing.
- `Agent` queries `NavMesh.findPath(start, goal)` and follows waypoints using the existing character controller.


## Troubleshooting

- No triangles exported:
  - Verify the property name matches your meshes (default `navigable`).
  - Lower the Max Slope angle, or ensure surfaces are not too steep.
  - Enable “Apply Modifiers” if your walkable surfaces are generated by modifiers.
- 404 loading navmesh in the browser:
  - Confirm the file exists at `public/build/assets/component-data/navmesh.json`.
  - The runtime default URL is `assets/component-data/navmesh.json` (relative to the site base). Adjust either the export path or the `NavMesh.url` param.
- Pathfinding looks off:
  - Ensure “Convert to Three.js (Y-up)” is enabled when exporting.
  - Check your scene/model scales are consistent between Blender and runtime.


## Alternative: Build-time Baking (Node)

If you prefer not to use Blender for baking, you can generate the navmesh from your GLB as a build step using a Recast-based tool (e.g., `@recast-navigation`). This keeps runtime light while avoiding a DCC dependency. Runtime baking in the browser is generally not recommended for performance reasons.


## Version

- Add-on tested with Blender 4.3+.

## Double-Sided Rendering (glTF and Add-on)

- Blender-native (preferred per-material): In Material Properties → Settings, turn OFF “Backface Culling”. The glTF exporter writes `material.doubleSided = true` for that material.
  - Keep this per material for the most accurate performance and visuals.
- Three64 Add-on (per-object override): Use “Mark Double-Sided” to set `doubleSided = True` on the object. The runtime reads this custom property (exported via glTF extras) and forces double-sided for materials on meshes under that object.
- Runtime behavior and precedence:
  - If the material is authored as double-sided in Blender (Backface Culling off), it will be double-sided.
  - If the object has `doubleSided = True`, Three64 forces double-sided for its meshes.
  - Global default remains single-sided for performance unless overridden per material or by the object property.

